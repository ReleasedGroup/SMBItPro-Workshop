@inherits LayoutComponentBase
@implements IDisposable
@inject ClientSession Session
@inject NavigationManager Navigation

<div class="shell-bg"></div>
<div class="shell">
    <header class="topbar">
        <button type="button" class="menu-toggle" @onclick="ToggleNav" aria-label="Toggle navigation">â˜°</button>
        <a href="/" class="brand">
            <span class="brand-mark">HL</span>
            <span class="brand-copy">
                <strong>Helpdesk-Light</strong>
                <small>MSP Ticket Operations</small>
            </span>
        </a>
        <div class="session-actions">
            @if (Session.IsAuthenticated)
            {
                <span class="session-pill">@Session.Email (@Session.Role)</span>
                <button type="button" class="button-link button-link-alt" @onclick="SignOut">Sign Out</button>
            }
            else
            {
                <a href="/login" class="button-link">Sign In</a>
            }
        </div>
    </header>

    <div class="shell-body">
        <aside class="sidebar @(isNavOpen ? "open" : string.Empty)">
            <NavMenu OnNavigate="CloseNav" />
        </aside>

        <main class="main-content" @onclick="CloseNav">
            @Body
        </main>
    </div>
</div>

@code {
    private bool isNavOpen;

    private void ToggleNav()
    {
        isNavOpen = !isNavOpen;
    }

    private void CloseNav()
    {
        isNavOpen = false;
    }

    protected override void OnInitialized()
    {
        Session.Changed += HandleSessionChanged;
    }

    private void HandleSessionChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void SignOut()
    {
        Session.Clear();
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        Session.Changed -= HandleSessionChanged;
    }
}
