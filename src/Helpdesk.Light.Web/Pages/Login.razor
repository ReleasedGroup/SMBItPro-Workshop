@page "/login"
@using Helpdesk.Light.Web.Models
@inject HelpdeskApiClient Api
@inject ClientSession Session
@inject NavigationManager Navigation

<PageTitle>Login</PageTitle>

<h1>Sign In</h1>
<p>Authenticate with a seeded account to unlock tenant-scoped ticket workflows.</p>

<EditForm Model="model" OnValidSubmit="SubmitAsync" class="panel login-panel">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <label>
        <span>Email</span>
        <InputText @bind-Value="model.Email" autocomplete="username" />
    </label>

    <label>
        <span>Password</span>
        <InputText @bind-Value="model.Password" type="password" autocomplete="current-password" />
    </label>

    <button type="submit" disabled="@isSubmitting">@buttonCopy</button>

    @if (!string.IsNullOrWhiteSpace(statusMessage))
    {
        <p class="status">@statusMessage</p>
    }

    <p class="hint">Seed users: `admin@msp.local`, `tech@contoso.com`, `tech@fabrikam.com`, `user@contoso.com`, `user@fabrikam.com` with password `Pass!12345`.</p>
</EditForm>

@code {
    private readonly LoginFormModel model = new();

    private bool isSubmitting;

    private string statusMessage = string.Empty;

    private string buttonCopy => isSubmitting ? "Signing in..." : "Sign In";

    private async Task SubmitAsync()
    {
        isSubmitting = true;
        statusMessage = string.Empty;

        try
        {
            LoginResponse? response = await Api.LoginAsync(new LoginRequest(model.Email, model.Password));
            if (response is null)
            {
                statusMessage = "Login failed. Check your credentials.";
                return;
            }

            Session.SetLogin(response);
            statusMessage = "Authenticated successfully.";
            Navigation.NavigateTo("/tickets", forceLoad: false);
        }
        catch
        {
            statusMessage = "Unable to contact API. Verify the backend is running and ApiBaseUrl is configured.";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
