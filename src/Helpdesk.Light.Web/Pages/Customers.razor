@page "/customers"
@inject HelpdeskApiClient Api
@inject ClientSession Session

<PageTitle>Customers</PageTitle>

<h1>Customer Administration</h1>
<p>MSP admin workspace for customer and end-user lifecycle management.</p>

@if (!Session.IsAuthenticated || Session.Role != "MspAdmin")
{
    <section class="panel">
        <p>Admin sign-in is required to manage customers, end users, and AI policies.</p>
    </section>
}
else
{
    <section class="panel-grid">
        <section class="panel">
            <h2>Customers</h2>
            <button type="button" @onclick="LoadCustomersAsync" disabled="@isBusy">Refresh</button>

            @if (customers.Count == 0)
            {
                <p>No customers loaded.</p>
            }
            else
            {
                <div class="ticket-list">
                    @foreach (CustomerSummaryDto customer in customers)
                    {
                        <button type="button" class="ticket-row @(selectedCustomerId == customer.Id ? "selected" : string.Empty)" @onclick="() => SelectCustomerAsync(customer.Id)">
                            <span>@customer.Name</span>
                            <span>@customer.Id</span>
                            <span>Domains: @customer.DomainCount</span>
                            <span>Active: @customer.IsActive</span>
                        </button>
                    }
                </div>
            }
        </section>

        <section class="panel">
            <h2>Create Customer</h2>
            <label>
                <span>Name</span>
                <input @bind="newCustomerName" />
            </label>
            <label>
                <span>
                    <input type="checkbox" @bind="newCustomerIsActive" />
                    Active
                </span>
            </label>
            <button type="button" @onclick="CreateCustomerAsync" disabled="@isBusy">Create Customer</button>
        </section>

        <section class="panel">
            <h2>Edit Customer</h2>
            <label>
                <span>Name</span>
                <input @bind="editCustomerName" disabled="@(!selectedCustomerId.HasValue)" />
            </label>
            <label>
                <span>
                    <input type="checkbox" @bind="editCustomerIsActive" disabled="@(!selectedCustomerId.HasValue)" />
                    Active
                </span>
            </label>
            <button type="button" @onclick="UpdateCustomerAsync" disabled="@isBusy || !selectedCustomerId.HasValue">Save Customer</button>
            <button type="button" @onclick="DeleteCustomerAsync" disabled="@isBusy || !selectedCustomerId.HasValue">Delete Customer</button>
        </section>
    </section>

    <section class="panel-grid">
        <section class="panel">
            <h2>Domain Mapping</h2>
            <label>
                <span>Domain</span>
                <input @bind="newDomain" placeholder="contoso.com" />
            </label>
            <label>
                <span>
                    <input type="checkbox" @bind="newDomainIsPrimary" />
                    Primary
                </span>
            </label>
            <button type="button" @onclick="AddDomainAsync" disabled="@isBusy || !selectedCustomerId.HasValue">Add Domain</button>
        </section>

        <section class="panel">
            <h2>AI Policy</h2>
            <label>
                <span>Mode</span>
                <select @bind="aiMode">
                    @foreach (AiPolicyMode mode in Enum.GetValues<AiPolicyMode>())
                    {
                        <option value="@mode">@mode</option>
                    }
                </select>
            </label>
            <label>
                <span>Auto-response Confidence (0-1)</span>
                <input type="number" step="0.05" min="0" max="1" @bind="confidenceText" />
            </label>
            <button type="button" @onclick="SavePolicyAsync" disabled="@isBusy || !selectedCustomerId.HasValue">Save Policy</button>
        </section>
    </section>

    <section class="panel-grid">
        <section class="panel">
            <h2>End Users</h2>
            <button type="button" @onclick="LoadEndUsersAsync" disabled="@isBusy || !selectedCustomerId.HasValue">Refresh End Users</button>

            @if (!selectedCustomerId.HasValue)
            {
                <p>Select a customer first.</p>
            }
            else if (endUsers.Count == 0)
            {
                <p>No end users found for this customer.</p>
            }
            else
            {
                <div class="ticket-list">
                    @foreach (EndUserSummaryDto user in endUsers)
                    {
                        <button type="button" class="ticket-row @(selectedEndUserId == user.Id ? "selected" : string.Empty)" @onclick="() => SelectEndUser(user.Id)">
                            <span>@user.DisplayName</span>
                            <span>@user.Email</span>
                            <span>Confirmed: @user.EmailConfirmed</span>
                        </button>
                    }
                </div>
            }
        </section>

        <section class="panel">
            <h2>Create End User</h2>
            <label>
                <span>Email</span>
                <input type="email" @bind="newEndUserEmail" placeholder="user@domain.com" />
            </label>
            <label>
                <span>Display Name</span>
                <input @bind="newEndUserDisplayName" />
            </label>
            <button type="button" @onclick="CreateEndUserAsync" disabled="@isBusy || !selectedCustomerId.HasValue">Create End User</button>
        </section>

        <section class="panel">
            <h2>Edit End User</h2>
            <label>
                <span>Email</span>
                <input type="email" @bind="editEndUserEmail" disabled="@(!selectedEndUserId.HasValue)" />
            </label>
            <label>
                <span>Display Name</span>
                <input @bind="editEndUserDisplayName" disabled="@(!selectedEndUserId.HasValue)" />
            </label>
            <label>
                <span>
                    <input type="checkbox" @bind="editEndUserEmailConfirmed" disabled="@(!selectedEndUserId.HasValue)" />
                    Email Confirmed
                </span>
            </label>
            <button type="button" @onclick="UpdateEndUserAsync" disabled="@isBusy || !selectedEndUserId.HasValue || !selectedCustomerId.HasValue">Save End User</button>
            <button type="button" @onclick="DeleteEndUserAsync" disabled="@isBusy || !selectedEndUserId.HasValue || !selectedCustomerId.HasValue">Delete End User</button>
        </section>
    </section>

    @if (!string.IsNullOrWhiteSpace(statusMessage))
    {
        <section class="panel"><p class="status">@statusMessage</p></section>
    }
}

@code {
    private bool isBusy;

    private readonly List<CustomerSummaryDto> customers = [];
    private readonly List<EndUserSummaryDto> endUsers = [];

    private Guid? selectedCustomerId;
    private Guid? selectedEndUserId;

    private string statusMessage = string.Empty;

    private string newCustomerName = string.Empty;
    private bool newCustomerIsActive = true;

    private string editCustomerName = string.Empty;
    private bool editCustomerIsActive = true;

    private string newDomain = string.Empty;
    private bool newDomainIsPrimary = true;

    private AiPolicyMode aiMode = AiPolicyMode.SuggestOnly;
    private string confidenceText = "0.80";

    private string newEndUserEmail = string.Empty;
    private string newEndUserDisplayName = string.Empty;

    private string editEndUserEmail = string.Empty;
    private string editEndUserDisplayName = string.Empty;
    private bool editEndUserEmailConfirmed = true;

    protected override async Task OnInitializedAsync()
    {
        if (Session.IsAuthenticated && Session.Role == "MspAdmin")
        {
            await LoadCustomersAsync();
        }
    }

    private async Task LoadCustomersAsync()
    {
        await RunBusyAsync(async () =>
        {
            IReadOnlyList<CustomerSummaryDto> loaded = await Api.ListCustomersAsync();
            customers.Clear();
            customers.AddRange(loaded);

            if (!selectedCustomerId.HasValue && customers.Count > 0)
            {
                await SelectCustomerAsync(customers[0].Id);
            }
            else if (selectedCustomerId.HasValue && customers.All(item => item.Id != selectedCustomerId.Value))
            {
                selectedCustomerId = null;
                ClearCustomerSelectionState();
            }
        }, "Failed to load customers");
    }

    private async Task SelectCustomerAsync(Guid customerId)
    {
        selectedCustomerId = customerId;
        selectedEndUserId = null;

        CustomerSummaryDto? customer = customers.FirstOrDefault(item => item.Id == customerId);
        editCustomerName = customer?.Name ?? string.Empty;
        editCustomerIsActive = customer?.IsActive ?? true;

        await LoadEndUsersAsync();
    }

    private async Task CreateCustomerAsync()
    {
        if (string.IsNullOrWhiteSpace(newCustomerName))
        {
            statusMessage = "Customer name is required.";
            return;
        }

        await RunBusyAsync(async () =>
        {
            CustomerSummaryDto created = await Api.CreateCustomerAsync(new CreateCustomerRequest(newCustomerName, newCustomerIsActive));
            newCustomerName = string.Empty;
            newCustomerIsActive = true;

            await LoadCustomersAsync();
            await SelectCustomerAsync(created.Id);
            statusMessage = "Customer created.";
        }, "Failed to create customer");
    }

    private async Task UpdateCustomerAsync()
    {
        if (!selectedCustomerId.HasValue)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(editCustomerName))
        {
            statusMessage = "Customer name is required.";
            return;
        }

        await RunBusyAsync(async () =>
        {
            await Api.UpdateCustomerAsync(selectedCustomerId.Value, new UpdateCustomerRequest(editCustomerName, editCustomerIsActive));
            await LoadCustomersAsync();
            statusMessage = "Customer updated.";
        }, "Failed to update customer");
    }

    private async Task DeleteCustomerAsync()
    {
        if (!selectedCustomerId.HasValue)
        {
            return;
        }

        Guid customerId = selectedCustomerId.Value;

        await RunBusyAsync(async () =>
        {
            await Api.DeleteCustomerAsync(customerId);
            selectedCustomerId = null;
            ClearCustomerSelectionState();
            await LoadCustomersAsync();
            statusMessage = "Customer deleted.";
        }, "Failed to delete customer");
    }

    private async Task AddDomainAsync()
    {
        if (!selectedCustomerId.HasValue)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(newDomain))
        {
            statusMessage = "Domain is required.";
            return;
        }

        await RunBusyAsync(async () =>
        {
            await Api.AddCustomerDomainAsync(selectedCustomerId.Value, new AddCustomerDomainRequest(newDomain, newDomainIsPrimary));
            newDomain = string.Empty;
            newDomainIsPrimary = true;
            await LoadCustomersAsync();
            statusMessage = "Domain added.";
        }, "Failed to add domain");
    }

    private async Task SavePolicyAsync()
    {
        if (!selectedCustomerId.HasValue)
        {
            return;
        }

        if (!double.TryParse(confidenceText, out double confidence))
        {
            statusMessage = "Confidence must be numeric.";
            return;
        }

        await RunBusyAsync(async () =>
        {
            await Api.UpdateCustomerAiPolicyAsync(selectedCustomerId.Value, new CustomerAiPolicyUpdateRequest(aiMode, confidence));
            statusMessage = "Policy updated.";
        }, "Failed to update policy");
    }

    private async Task LoadEndUsersAsync()
    {
        if (!selectedCustomerId.HasValue)
        {
            endUsers.Clear();
            selectedEndUserId = null;
            return;
        }

        await RunBusyAsync(async () =>
        {
            IReadOnlyList<EndUserSummaryDto> loaded = await Api.ListCustomerEndUsersAsync(selectedCustomerId.Value);
            endUsers.Clear();
            endUsers.AddRange(loaded);

            if (selectedEndUserId.HasValue && endUsers.All(item => item.Id != selectedEndUserId.Value))
            {
                selectedEndUserId = null;
                ClearEndUserEditState();
            }
        }, "Failed to load end users");
    }

    private async Task CreateEndUserAsync()
    {
        if (!selectedCustomerId.HasValue)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(newEndUserEmail) || string.IsNullOrWhiteSpace(newEndUserDisplayName))
        {
            statusMessage = "End-user email and display name are required.";
            return;
        }

        await RunBusyAsync(async () =>
        {
            EndUserSummaryDto created = await Api.CreateCustomerEndUserAsync(
                selectedCustomerId.Value,
                new CreateEndUserRequest(newEndUserEmail, newEndUserDisplayName));

            newEndUserEmail = string.Empty;
            newEndUserDisplayName = string.Empty;

            await LoadEndUsersAsync();
            SelectEndUser(created.Id);
            statusMessage = "End user created.";
        }, "Failed to create end user");
    }

    private void SelectEndUser(Guid userId)
    {
        selectedEndUserId = userId;
        EndUserSummaryDto? user = endUsers.FirstOrDefault(item => item.Id == userId);
        editEndUserEmail = user?.Email ?? string.Empty;
        editEndUserDisplayName = user?.DisplayName ?? string.Empty;
        editEndUserEmailConfirmed = user?.EmailConfirmed ?? true;
    }

    private async Task UpdateEndUserAsync()
    {
        if (!selectedCustomerId.HasValue || !selectedEndUserId.HasValue)
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(editEndUserEmail) || string.IsNullOrWhiteSpace(editEndUserDisplayName))
        {
            statusMessage = "End-user email and display name are required.";
            return;
        }

        await RunBusyAsync(async () =>
        {
            await Api.UpdateCustomerEndUserAsync(
                selectedCustomerId.Value,
                selectedEndUserId.Value,
                new UpdateEndUserRequest(editEndUserEmail, editEndUserDisplayName, editEndUserEmailConfirmed));

            await LoadEndUsersAsync();
            statusMessage = "End user updated.";
        }, "Failed to update end user");
    }

    private async Task DeleteEndUserAsync()
    {
        if (!selectedCustomerId.HasValue || !selectedEndUserId.HasValue)
        {
            return;
        }

        Guid userId = selectedEndUserId.Value;

        await RunBusyAsync(async () =>
        {
            await Api.DeleteCustomerEndUserAsync(selectedCustomerId.Value, userId);
            selectedEndUserId = null;
            ClearEndUserEditState();
            await LoadEndUsersAsync();
            statusMessage = "End user deleted.";
        }, "Failed to delete end user");
    }

    private async Task RunBusyAsync(Func<Task> action, string errorPrefix)
    {
        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            await action();
        }
        catch (Exception exception)
        {
            statusMessage = $"{errorPrefix}: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private void ClearCustomerSelectionState()
    {
        editCustomerName = string.Empty;
        editCustomerIsActive = true;
        endUsers.Clear();
        selectedEndUserId = null;
        ClearEndUserEditState();
    }

    private void ClearEndUserEditState()
    {
        editEndUserEmail = string.Empty;
        editEndUserDisplayName = string.Empty;
        editEndUserEmailConfirmed = true;
    }
}
