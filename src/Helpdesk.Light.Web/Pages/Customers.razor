@page "/customers"
@inject HelpdeskApiClient Api
@inject ClientSession Session

<PageTitle>Customers</PageTitle>

<h1>Customer Administration</h1>
<p>Tenant mapping and AI policy controls for MSP admins.</p>

@if (!Session.IsAuthenticated || Session.Role != "MspAdmin")
{
    <section class="panel">
        <p>Admin sign-in is required to manage customers and AI policies.</p>
    </section>
}
else
{
    <section class="panel-grid">
        <section class="panel">
            <h2>Customers</h2>
            <button type="button" @onclick="LoadCustomersAsync" disabled="@isBusy">Refresh</button>

            @if (customers.Count == 0)
            {
                <p>No customers loaded.</p>
            }
            else
            {
                <div class="ticket-list">
                    @foreach (CustomerSummaryDto customer in customers)
                    {
                        <button type="button" class="ticket-row @(selectedCustomerId == customer.Id ? "selected" : string.Empty)" @onclick="() => SelectCustomer(customer.Id)">
                            <span>@customer.Name</span>
                            <span>@customer.Id</span>
                            <span>Domains: @customer.DomainCount</span>
                        </button>
                    }
                </div>
            }
        </section>

        <section class="panel">
            <h2>AI Policy</h2>
            <p>Set customer policy mode and confidence threshold for auto-response.</p>

            <label>
                <span>Mode</span>
                <select @bind="aiMode">
                    @foreach (AiPolicyMode mode in Enum.GetValues<AiPolicyMode>())
                    {
                        <option value="@mode">@mode</option>
                    }
                </select>
            </label>

            <label>
                <span>Auto-response Confidence (0-1)</span>
                <input type="number" step="0.05" min="0" max="1" @bind="confidenceText" />
            </label>

            <button type="button" @onclick="SavePolicyAsync" disabled="@isBusy || !selectedCustomerId.HasValue">Save Policy</button>
        </section>
    </section>

    @if (!string.IsNullOrWhiteSpace(statusMessage))
    {
        <section class="panel"><p class="status">@statusMessage</p></section>
    }
}

@code {
    private bool isBusy;
    private readonly List<CustomerSummaryDto> customers = [];
    private Guid? selectedCustomerId;
    private string statusMessage = string.Empty;
    private AiPolicyMode aiMode = AiPolicyMode.SuggestOnly;
    private string confidenceText = "0.80";

    protected override async Task OnInitializedAsync()
    {
        if (Session.IsAuthenticated && Session.Role == "MspAdmin")
        {
            await LoadCustomersAsync();
        }
    }

    private async Task LoadCustomersAsync()
    {
        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            IReadOnlyList<CustomerSummaryDto> loaded = await Api.ListCustomersAsync();
            customers.Clear();
            customers.AddRange(loaded);

            if (!selectedCustomerId.HasValue && customers.Count > 0)
            {
                selectedCustomerId = customers[0].Id;
            }
        }
        catch (Exception exception)
        {
            statusMessage = $"Failed to load customers: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private void SelectCustomer(Guid customerId)
    {
        selectedCustomerId = customerId;
    }

    private async Task SavePolicyAsync()
    {
        if (!selectedCustomerId.HasValue)
        {
            return;
        }

        if (!double.TryParse(confidenceText, out double confidence))
        {
            statusMessage = "Confidence must be numeric.";
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            await Api.UpdateCustomerAiPolicyAsync(selectedCustomerId.Value, new CustomerAiPolicyUpdateRequest(aiMode, confidence));
            statusMessage = "Policy updated.";
        }
        catch (Exception exception)
        {
            statusMessage = $"Failed to update policy: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }
}
