@page "/tickets"
@inject HelpdeskApiClient Api
@inject ClientSession Session
@implements IDisposable

<PageTitle>Tickets</PageTitle>

<h1>Tickets Workspace</h1>
<p>Unified view for end-user ticket tracking and technician queue operations.</p>

@if (!Session.IsAuthenticated)
{
    <section class="panel">
        <h2>Authentication Required</h2>
        <p>Sign in to create or manage tickets.</p>
        <a href="/login" class="button-link">Go to Login</a>
    </section>
}
else
{
    <section class="panel-grid">
        <section class="panel">
            <h2>Create Ticket</h2>
            <label>
                <span>End-user Email</span>
                <input type="email" @bind="newTicketEndUserEmail" placeholder="user@customer-domain.com" />
            </label>
            <label>
                <span>Subject</span>
                <input @bind="newTicketSubject" />
            </label>
            <label>
                <span>Description</span>
                <textarea rows="4" @bind="newTicketDescription"></textarea>
            </label>
            <label>
                <span>Priority</span>
                <select @bind="newTicketPriority">
                    @foreach (TicketPriority value in Enum.GetValues<TicketPriority>())
                    {
                        <option value="@value">@value</option>
                    }
                </select>
            </label>
            <p class="hint">Customer is assigned from email domain; unknown domains are auto-provisioned as new customers.</p>

            <label>
                <span>Attachments</span>
                <InputFile OnChange="OnCreateAttachmentChange" multiple />
            </label>

            <button type="button" @onclick="CreateTicketAsync" disabled="@isBusy">Create Ticket</button>
        </section>

        <section class="panel">
            <h2>Queue Filters</h2>
            <label>
                <span>Status</span>
                <select @bind="filterStatusText">
                    <option value="">Any</option>
                    @foreach (TicketStatus value in Enum.GetValues<TicketStatus>())
                    {
                        <option value="@value">@value</option>
                    }
                </select>
            </label>
            <label>
                <span>Priority</span>
                <select @bind="filterPriorityText">
                    <option value="">Any</option>
                    @foreach (TicketPriority value in Enum.GetValues<TicketPriority>())
                    {
                        <option value="@value">@value</option>
                    }
                </select>
            </label>
            @if (IsAdmin)
            {
                <label>
                    <span>Customer Id</span>
                    <input @bind="filterCustomerIdText" placeholder="Guid" />
                </label>
            }
            @if (CanManage)
            {
                <label>
                    <span>Assigned User Id</span>
                    <input @bind="filterAssignedToText" placeholder="Guid" />
                </label>
            }
            <button type="button" @onclick="LoadTicketsAsync" disabled="@isBusy">Refresh Queue</button>
        </section>
    </section>

    <section class="panel">
        <h2>Ticket List (@tickets.Count)</h2>
        @if (tickets.Count == 0)
        {
            <p>No tickets found for the current filter and role scope.</p>
        }
        else
        {
            <div class="ticket-list">
                @foreach (TicketSummaryDto ticket in tickets)
                {
                    <button type="button" class="ticket-row @(selectedTicket?.Ticket.Id == ticket.Id ? "selected" : string.Empty)" @onclick="() => SelectTicketAsync(ticket.Id)">
                        <span>@ticket.ReferenceCode</span>
                        <span>@ticket.Subject</span>
                        <span>@ticket.Status</span>
                        <span>@ticket.Priority</span>
                        <span>@ticket.Category</span>
                    </button>
                }
            </div>
        }
    </section>

    @if (selectedTicket is not null)
    {
        <section class="panel-grid">
            <section class="panel">
                <h2>Ticket Detail</h2>
                <p><strong>@selectedTicket.Ticket.ReferenceCode</strong> - @selectedTicket.Ticket.Subject</p>
                <p>Status: @selectedTicket.Ticket.Status | Priority: @selectedTicket.Ticket.Priority | Category: @selectedTicket.Ticket.Category</p>
                <p>Assigned User: @(selectedTicket.Ticket.AssignedToUserId?.ToString() ?? "Unassigned")</p>
                <p>Assigned Resolver Group: @(selectedTicket.Ticket.ResolverGroupId?.ToString() ?? "Unassigned")</p>

                <h3>Conversation Timeline</h3>
                <div class="timeline">
                    @foreach (TicketMessageDto message in selectedTicket.Messages)
                    {
                        <article class="timeline-item">
                            <header>@message.AuthorType | @message.Source | @message.CreatedUtc.ToLocalTime()</header>
                            <p>@message.Body</p>
                        </article>
                    }
                </div>

                <label>
                    <span>Post Reply</span>
                    <textarea rows="3" @bind="newMessageBody"></textarea>
                </label>
                <button type="button" @onclick="AddMessageAsync" disabled="@isBusy">Send Message</button>

                <label>
                    <span>Attach File</span>
                    <InputFile OnChange="OnDetailAttachmentChange" />
                </label>

                <h3>Attachments</h3>
                @if (selectedTicket.Attachments.Count == 0)
                {
                    <p>No attachments.</p>
                }
                else
                {
                    <ul>
                        @foreach (TicketAttachmentDto attachment in selectedTicket.Attachments)
                        {
                            <li>@attachment.FileName (@attachment.SizeBytes bytes)</li>
                        }
                    </ul>
                }
            </section>

            @if (CanManage)
            {
                <section class="panel">
                    <h2>Technician Actions</h2>
                    <label>
                        <span>Assign To Resolver User</span>
                        <select @bind="assignToUserIdText">
                            <option value="">Unassigned</option>
                            @foreach (ResolverUserSummaryDto user in resolverUsers)
                            {
                                <option value="@user.Id">@FormatResolverUserOption(user)</option>
                            }
                        </select>
                    </label>
                    <label>
                        <span>Assign To Resolver Group</span>
                        <select @bind="assignResolverGroupIdText">
                            <option value="">Unassigned</option>
                            @foreach (ResolverGroupSummaryDto group in resolverGroups)
                            {
                                <option value="@group.Id">@group.Name (@(group.IsActive ? "Active" : "Inactive"))</option>
                            }
                        </select>
                    </label>
                    <p class="hint">Choose either resolver user or resolver group, or clear both.</p>
                    <button type="button" @onclick="AssignAsync" disabled="@isBusy">Apply Assignment</button>

                    <label>
                        <span>Set Status</span>
                        <select @bind="manageStatus">
                            @foreach (TicketStatus value in Enum.GetValues<TicketStatus>())
                            {
                                <option value="@value">@value</option>
                            }
                        </select>
                    </label>
                    <button type="button" @onclick="UpdateStatusAsync" disabled="@isBusy">Update Status</button>

                    <label>
                        <span>Triage Priority</span>
                        <select @bind="managePriority">
                            @foreach (TicketPriority value in Enum.GetValues<TicketPriority>())
                            {
                                <option value="@value">@value</option>
                            }
                        </select>
                    </label>
                    <label>
                        <span>Triage Category</span>
                        <input @bind="manageCategory" list="category-options" />
                    </label>
                    <datalist id="category-options">
                        @foreach (TicketCategorySummaryDto category in manageCategories)
                        {
                            <option value="@category.Name"></option>
                        }
                    </datalist>
                    <button type="button" @onclick="UpdateTriageAsync" disabled="@isBusy">Update Triage</button>
                </section>

                <section class="panel">
                    <h2>AI Agent</h2>
                    <button type="button" @onclick="RunAiAsync" disabled="@isBusy">Run AI Triage</button>

                    @if (selectedTicket.LatestAiSuggestion is not null)
                    {
                        <p>Status: @selectedTicket.LatestAiSuggestion.Status</p>
                        <p>Confidence: @selectedTicket.LatestAiSuggestion.Confidence</p>
                        <p>Risk: @selectedTicket.LatestAiSuggestion.RiskLevel</p>
                        <p>Suggested Priority: @selectedTicket.LatestAiSuggestion.SuggestedPriority</p>
                        <p>Suggested Category: @selectedTicket.LatestAiSuggestion.SuggestedCategory</p>
                        <label>
                            <span>Draft Response</span>
                            <textarea rows="5" @bind="aiEditedResponse"></textarea>
                        </label>

                        @if (selectedTicket.LatestAiSuggestion.Status == AiSuggestionStatus.PendingApproval)
                        {
                            <button type="button" @onclick="ApproveAiAsync" disabled="@isBusy">Approve & Send</button>
                            <button type="button" @onclick="DiscardAiAsync" disabled="@isBusy">Discard</button>
                        }
                    }
                    else
                    {
                        <p>No AI suggestions yet.</p>
                    }
                </section>
            }
        </section>
    }

    @if (!string.IsNullOrWhiteSpace(statusMessage))
    {
        <section class="panel"><p class="status">@statusMessage</p></section>
    }
}

@code {
    private readonly List<TicketSummaryDto> tickets = [];

    private TicketDetailDto? selectedTicket;
    private bool isBusy;
    private string statusMessage = string.Empty;

    private string newTicketSubject = string.Empty;
    private string newTicketDescription = string.Empty;
    private string newTicketEndUserEmail = string.Empty;
    private TicketPriority newTicketPriority = TicketPriority.Medium;
    private IReadOnlyList<IBrowserFile> createAttachments = [];

    private string filterStatusText = string.Empty;
    private string filterPriorityText = string.Empty;
    private string filterCustomerIdText = string.Empty;
    private string filterAssignedToText = string.Empty;

    private string newMessageBody = string.Empty;
    private readonly List<ResolverUserSummaryDto> resolverUsers = [];
    private readonly List<ResolverGroupSummaryDto> resolverGroups = [];
    private readonly List<TicketCategorySummaryDto> manageCategories = [];
    private string assignToUserIdText = string.Empty;
    private string assignResolverGroupIdText = string.Empty;
    private TicketStatus manageStatus = TicketStatus.InProgress;
    private TicketPriority managePriority = TicketPriority.Medium;
    private string manageCategory = string.Empty;
    private string aiEditedResponse = string.Empty;

    private bool IsAdmin => Session.Role == "MspAdmin";
    private bool IsEndUser => Session.Role == "EndUser";
    private bool CanManage => Session.Role is "Technician" or "MspAdmin";

    protected override async Task OnInitializedAsync()
    {
        Session.Changed += OnSessionChanged;
        if (Session.IsAuthenticated)
        {
            if (IsEndUser)
            {
                newTicketEndUserEmail = Session.Email;
            }

            await LoadTicketsAsync();
        }
    }

    private void OnSessionChanged()
    {
        _ = InvokeAsync(async () =>
        {
            if (Session.IsAuthenticated)
            {
                if (IsEndUser)
                {
                    newTicketEndUserEmail = Session.Email;
                }

                await LoadTicketsAsync();
            }
            else
            {
                tickets.Clear();
                selectedTicket = null;
            }

            StateHasChanged();
        });
    }

    private async Task LoadTicketsAsync()
    {
        if (!Session.IsAuthenticated)
        {
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            TicketStatus? status = Enum.TryParse<TicketStatus>(filterStatusText, out TicketStatus parsedStatus) ? parsedStatus : null;
            TicketPriority? priority = Enum.TryParse<TicketPriority>(filterPriorityText, out TicketPriority parsedPriority) ? parsedPriority : null;
            Guid? customerId = ParseGuidNullable(filterCustomerIdText);
            Guid? assignedTo = ParseGuidNullable(filterAssignedToText);

            IReadOnlyList<TicketSummaryDto> loaded = await Api.ListTicketsAsync(new TicketFilterRequest(status, priority, customerId, assignedTo, 100));

            tickets.Clear();
            tickets.AddRange(loaded);

            if (selectedTicket is not null && tickets.All(item => item.Id != selectedTicket.Ticket.Id))
            {
                selectedTicket = null;
            }
        }
        catch (Exception exception)
        {
            statusMessage = $"Failed to load tickets: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task SelectTicketAsync(Guid ticketId)
    {
        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            selectedTicket = await Api.GetTicketAsync(ticketId);
            if (selectedTicket is not null)
            {
                assignToUserIdText = selectedTicket.Ticket.AssignedToUserId?.ToString() ?? string.Empty;
                assignResolverGroupIdText = selectedTicket.Ticket.ResolverGroupId?.ToString() ?? string.Empty;
                if (CanManage)
                {
                    await LoadResolverOptionsAsync(selectedTicket.Ticket.CustomerId);
                    await LoadManageCategoriesAsync(selectedTicket.Ticket.CustomerId);
                }

                if (selectedTicket.LatestAiSuggestion is not null)
                {
                    aiEditedResponse = selectedTicket.LatestAiSuggestion.DraftResponse;
                }

                managePriority = selectedTicket.Ticket.Priority;
                manageStatus = selectedTicket.Ticket.Status;
                manageCategory = selectedTicket.Ticket.Category ?? string.Empty;
            }
        }
        catch (Exception exception)
        {
            statusMessage = $"Failed to load ticket detail: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task CreateTicketAsync()
    {
        if (string.IsNullOrWhiteSpace(newTicketSubject) || string.IsNullOrWhiteSpace(newTicketDescription))
        {
            statusMessage = "Subject and description are required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(newTicketEndUserEmail))
        {
            statusMessage = "End-user email is required.";
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            CreateTicketRequest request = new(null, newTicketSubject, newTicketDescription, newTicketPriority, newTicketEndUserEmail);
            TicketSummaryDto created = await Api.CreateTicketAsync(request);

            foreach (IBrowserFile file in createAttachments)
            {
                await using Stream stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                await Api.UploadAttachmentAsync(created.Id, file.Name, file.ContentType, stream);
            }

            newTicketSubject = string.Empty;
            newTicketDescription = string.Empty;
            newTicketPriority = TicketPriority.Medium;
            if (IsEndUser)
            {
                newTicketEndUserEmail = Session.Email;
            }
            else
            {
                newTicketEndUserEmail = string.Empty;
            }
            createAttachments = [];

            await LoadTicketsAsync();
            await SelectTicketAsync(created.Id);
            statusMessage = $"Ticket {created.ReferenceCode} created.";
        }
        catch (Exception exception)
        {
            statusMessage = $"Failed to create ticket: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private void OnCreateAttachmentChange(InputFileChangeEventArgs args)
    {
        createAttachments = args.GetMultipleFiles();
    }

    private async Task AddMessageAsync()
    {
        if (selectedTicket is null || string.IsNullOrWhiteSpace(newMessageBody))
        {
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            await Api.AddMessageAsync(selectedTicket.Ticket.Id, new TicketMessageCreateRequest(newMessageBody));
            newMessageBody = string.Empty;
            await LoadTicketsAsync();
            await SelectTicketAsync(selectedTicket.Ticket.Id);
        }
        catch (Exception exception)
        {
            statusMessage = $"Failed to post message: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task OnDetailAttachmentChange(InputFileChangeEventArgs args)
    {
        if (selectedTicket is null)
        {
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            foreach (IBrowserFile file in args.GetMultipleFiles())
            {
                await using Stream stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                await Api.UploadAttachmentAsync(selectedTicket.Ticket.Id, file.Name, file.ContentType, stream);
            }

            await SelectTicketAsync(selectedTicket.Ticket.Id);
        }
        catch (Exception exception)
        {
            statusMessage = $"Attachment upload failed: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task AssignAsync()
    {
        if (!CanManage || selectedTicket is null)
        {
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            Guid? assignedTo = ParseGuidNullable(assignToUserIdText);
            Guid? resolverGroupId = ParseGuidNullable(assignResolverGroupIdText);

            if (assignedTo.HasValue && resolverGroupId.HasValue)
            {
                statusMessage = "Choose a resolver user or resolver group, not both.";
                return;
            }

            await Api.AssignAsync(selectedTicket.Ticket.Id, new TicketAssignRequest(assignedTo, resolverGroupId));
            await LoadTicketsAsync();
            await SelectTicketAsync(selectedTicket.Ticket.Id);
        }
        catch (Exception exception)
        {
            statusMessage = $"Assignment failed: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task LoadResolverOptionsAsync(Guid customerId)
    {
        ResolverAssignmentOptionsDto options = await Api.GetResolverAssignmentOptionsAsync(customerId);
        resolverUsers.Clear();
        resolverUsers.AddRange(options.Users);
        resolverGroups.Clear();
        resolverGroups.AddRange(options.Groups);
    }

    private async Task LoadManageCategoriesAsync(Guid customerId)
    {
        IReadOnlyList<TicketCategorySummaryDto> categories = await Api.ListTicketCategoriesAsync(customerId);
        manageCategories.Clear();
        manageCategories.AddRange(categories.Where(item => item.IsActive).OrderBy(item => item.Name));
    }

    private async Task UpdateStatusAsync()
    {
        if (!CanManage || selectedTicket is null)
        {
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            await Api.UpdateStatusAsync(selectedTicket.Ticket.Id, new TicketStatusUpdateRequest(manageStatus));
            await LoadTicketsAsync();
            await SelectTicketAsync(selectedTicket.Ticket.Id);
        }
        catch (Exception exception)
        {
            statusMessage = $"Status update failed: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task UpdateTriageAsync()
    {
        if (!CanManage || selectedTicket is null)
        {
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            await Api.UpdateTriageAsync(selectedTicket.Ticket.Id, new TicketTriageUpdateRequest(managePriority, manageCategory));
            await LoadTicketsAsync();
            await SelectTicketAsync(selectedTicket.Ticket.Id);
        }
        catch (Exception exception)
        {
            statusMessage = $"Triage update failed: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task RunAiAsync()
    {
        if (!CanManage || selectedTicket is null)
        {
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            await Api.RunAiAsync(selectedTicket.Ticket.Id);
            await SelectTicketAsync(selectedTicket.Ticket.Id);
            await LoadTicketsAsync();
        }
        catch (Exception exception)
        {
            statusMessage = $"AI run failed: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task ApproveAiAsync()
    {
        if (!CanManage || selectedTicket is null)
        {
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            await Api.ApproveAiAsync(selectedTicket.Ticket.Id, new TicketAiApprovalRequest(aiEditedResponse));
            await SelectTicketAsync(selectedTicket.Ticket.Id);
            await LoadTicketsAsync();
        }
        catch (Exception exception)
        {
            statusMessage = $"AI approval failed: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task DiscardAiAsync()
    {
        if (!CanManage || selectedTicket is null)
        {
            return;
        }

        isBusy = true;
        statusMessage = string.Empty;

        try
        {
            await Api.DiscardAiAsync(selectedTicket.Ticket.Id);
            await SelectTicketAsync(selectedTicket.Ticket.Id);
            await LoadTicketsAsync();
        }
        catch (Exception exception)
        {
            statusMessage = $"AI discard failed: {exception.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    private static Guid? ParseGuidNullable(string raw)
    {
        if (Guid.TryParse(raw, out Guid parsed))
        {
            return parsed;
        }

        return null;
    }

    private static string FormatResolverUserOption(ResolverUserSummaryDto user)
    {
        return $"{user.DisplayName} ({user.Role}) - {user.Email}";
    }

    public void Dispose()
    {
        Session.Changed -= OnSessionChanged;
    }
}
